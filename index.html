<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>TopTrackz</title>
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="TopTrackz" />
  <link rel="manifest" href="manifest.json" />
  <link rel="apple-touch-icon" href="icon.png" />
  <style>
    /* (CSS bleibt gleich wie vorher – ausgelassen für Übersicht) */
  </style>
</head>
<body>
  <div id="startScreen" class="screen active">
    <h1>TopTrackz</h1>
    <button onclick="goTo('modeScreen')">Start</button>
    <div id="debug-token"></div>
  </div>

  <!-- Spotify-Login Button -->
  <div id="spotify-login">
    <button id="spotifyButton">Mit Spotify verbinden</button>
  </div>

  <script>
    const CLIENT_ID = "9fb9db7417034d34971b1defb719cdc8";
    const REDIRECT_URI = "https://sabine187.github.io/TopTrackz/";
    const SCOPES = "streaming user-read-email user-read-private user-modify-playback-state user-read-playback-state";

    document.getElementById("spotifyButton").addEventListener("click", function () {
      const authEndpoint = "https://accounts.spotify.com/authorize";
      const url = `${authEndpoint}?client_id=${CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}&response_type=token&show_dialog=true`;
      window.location.href = url;
    });

    function showDebugToken() {
      const token = localStorage.getItem("spotify_access_token");
      document.getElementById("debug-token").textContent = token ? "Token gespeichert ✅" : "Kein Token ❌";
    }

    // Wenn ein access_token in der URL ist, speichern und bereinigen
    if (window.location.hash.includes("access_token")) {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const token = params.get("access_token");
      if (token) {
        localStorage.setItem("spotify_access_token", token);
        window.location.hash = ""; // URL bereinigen
      }
    }

    if (window.location.hash === "#reset") {
      localStorage.removeItem("spotify_access_token");
      const cleanUrl = window.location.origin + window.location.pathname;
      window.location.replace(cleanUrl);
    }

    window.onload = function () {
      const token = localStorage.getItem("spotify_access_token");
      showDebugToken();
      if (token) {
        goTo("modeScreen");
      }
    };

    function goTo(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }
  </script>
</body>
</html>
